<%= stylesheet_link_tag 'booking-forms' %>
<hr>
<div class="row" id='ride-offer-area'>

  <div class="col-md-11 noSelect">
    <p><b><h3>Driving to <%=@event.title%>?</h3></b></p><br/>
    <% if flash[:notice] %>
      <h4><span class="notice" style="color:rgba(185, 4, 5, 0.6500)"><%= flash[:notice] %></span></h4>
      <% end %>
      <% if current_user != nil %>
        
        
        <div id="ride-offer-prompt"><h4>Where's your ride leaving from?</h4></div>
       
        <div id="ride_flow_1" class="input-group">
          <input type="text" class="form-control" id="origin" placeholder="This party kicks off from..."  autocomplete="off" />  
          <span class="input-group-addon" id="origin-button"><i class="fa fa-1x fa-forward"></i></span>
        </div>

        <div id="ride_flow_2">
      
          <h4><div id="num-seats-counter" class="seats-counter center-it">
            <i id="seat-minus" class="fa fa-1x fa-minus-square cursorOn"></i>
            <span id="seats-counter">1</span>
            <i id="seat-plus" class="fa fa-1x fa-plus-square cursorOn"></i>
             <i class="fa fa-2x fa-thumbs-o-up cursorOn" id="num-seats-thumb"></i>
          </div></h4>

         (Preferably with seatbelts.)
        </div>

        <div id="ride_flow_3" class="input-group">

          <h4><div id="price_per_seat-counter" class="seats-counter center-it">
            <i id="price-minus" class="fa fa-1x fa-minus-square cursorOn"></i>
            <span id="price-counter"><span style="font-size:0.7em">$</span><span id="price-value">10</span></span>
            <i id="price-plus" class="fa fa-1x fa-plus-square cursorOn"></i>
             <i class="fa fa-2x fa-thumbs-o-up cursorOn" id="price-thumb"></i>
          </div></h4>

            <!-- 
            <input type="text" class="form-control" id="price_per_seat" placeholder="Don't blow it all at once."  autocomplete="off" />
             <span class="input-group-addon" id="price-forward"><i class="fa fa-1x fa-forward"></i></span> -->
        </div>

        <div id="ride_flow_4" class="input-group"> 

          <input type="text" class="form-control" id="departure" placeholder="Tomorrow? Next week?"  autocomplete="off" />  
          <span class="input-group-addon" id="departure-button"><i class="fa fa-1x fa-forward"></i></span>
        </div>

        <div id="ride_flow_5" class="input-group"> 

          <input type="text" class="form-control" id="ride-name" placeholder="e.g. Choo choo!"  autocomplete="off" />
          <span class="input-group-addon" id="name-button"><i class="fa fa-1x fa-forward"></i></span>
        </div>

      <%= csrf_meta_tag %>

      <% else %>
        <h4><a href="/users/sign_in" style="color:grey">Please login!</a></h4>
      <% end %>

  </div>



  
  <!-- End col-md-12 -->


</div>

<hr>


<script type="text/javascript">

  $(document).ready(function() {

    //Variables to be filled
    var origin;
    var max_seats;
    var price_per_seat;
    var departure_time_local;
    var name;
    var image;

    //Various prompts
    var prompt_1 = "<h4>Where's your ride leaving from?</h4>";
    var prompt_2 = "<h4>How many free seats do you have?</h4>";
    var prompt_3 = "<h4>How much should we charge per seat?</h4>";
    var prompt_4 = "<h4>When are you leaving?</h4>";
    var prompt_5 = "<h4>Give your ride a name!</h4>";
    var prompt_6 = "<h4>Alright, let's do it!</h4>";
    var renderPrompt = function() {
      var prompt_space = $('#ride-offer-prompt');
      var i = ride_flow;
      if (ride_flow == 1) {
        prompt_space.html(prompt_1);
      } else if (ride_flow == 2) {
        prompt_space.html(prompt_2);
      } else if (ride_flow == 3) {
        prompt_space.html(prompt_3);
      } else if (ride_flow == 4) {
        prompt_space.html(prompt_4);
      } else if (ride_flow == 5) {
        prompt_space.html(prompt_5);
      } else if (ride_flow == 6) {
        prompt_space.html(prompt_6);
      } else if (ride_flow == 7) {
        prompt_space.html(prompt_7);
      };
      $('#ride_flow_'+i).show();
    };

    //Handle the ride offer flow
    var ride_flow = 0;

    for(var i=1; i<=6; i++) {
      $("#ride_flow_"+i).hide();
      ride_flow = 1;
      //alert('ok');
    }
    renderPrompt();

    //Handle inputs
    //Need to add fast-forward button on click
    //Origin

    var nextFlow = function() {
      $('#ride_flow_'+ride_flow).hide();
        ride_flow +=1;
        renderPrompt();
    };

  //Origin functions
    $('#origin').keypress(function(e) {
      if(e.which == 13) {
        origin = $('#origin').val();
        console.log(origin);
        if(origin) {
          nextFlow();
        }
      // enter pressed
      };
    });

    $('#origin-button').on('click', function() {
      origin = $('#origin').val();
      console.log(origin);
      if(origin) {
        nextFlow();
      };
    });
  //End origin functions

  //Num-seats functions
    $('#num-seats-thumb').on('click', function() {
      max_seats = parseInt($('#seats-counter').text());
      console.log(max_seats);
      nextFlow();
    });

    $('#price_per_seat').keypress(function(e) {
      if(e.which == 13) {
        price_per_seat = $('#price_per_seat').val();
        console.log(price_per_seat);
        nextFlow();
      // enter pressed
      };
    });

    $('#departure_button').on('click', function(e) {
        departure_time_local = $('#departure_time_local').val();
        console.log(departure_time_local);
        nextFlow();
      // enter pressed
    });

    var determineNumberSeats = function() {
      return parseInt($('#seats-counter').text());
    };

  //Seat number functions
    var seatClick = function(direction) {
      var numSeatsCount = determineNumberSeats();
      numSeatsCount += direction; //execute the direction before the validity check
      if(numSeatsCount >= 1) { //Ensure we don't go below zero
        // console.log('validclick!', numSeatsCount);
        $('#seats-counter').text(numSeatsCount);
        // recalculatePrice();
      };
    };

    //Click plus button
    $('#seat-plus').on('click', function() {
      seatClick(1);
    });
    //Click minus button
    $('#seat-minus').on('click', function() {
      seatClick(-1);
    });
  //End seat number functions

  //Pricing functions 
    var determinePrice = function() {
      return parseInt($('#price-value').text());
    };

    var priceClick = function(direction) {
      var priceCount = determinePrice();
      priceCount += direction; //execute the direction before the validity check
      if(priceCount >= 0) { //Ensure we don't go below zero
        // console.log('validclick!', numSeatsCount);
        $('#price-value').text(priceCount);
        // recalculatePrice();
      };
    };

    //Click plus button
    $('#price-plus').on('click', function() {
      priceClick(10);
    });

    //Click minus button
    $('#price-minus').on('click', function() {
      priceClick(-10);
    });

    $('#price-thumb').on('click', function() {
      price_per_seat = parseInt($('#price-value').text());
      console.log(price_per_seat);
      nextFlow();
    });

  //Can/should be refactored to be more DRY for both seat and price clicks.
  //End pricing functions

  //Departure date function

    $('#departure-button').on('click', function() {
      departure_time_local = $('#departure').val();
      console.log(departure_time_local);
      if(departure_time_local) {
        nextFlow();
      };
    });

    $('#departure').keypress(function(e) {
      if(e.which == 13) {
        departure_time_local = $('#departure').val();
        console.log(departure_time_local);
        if(departure_time_local) {
          nextFlow();
        };
      // enter pressed
      };
    });

  //End departure date function


  //Ride name functions
    $('#name-button').on('click', function() {
      name = $('#ride-name').val();
      console.log(name);
      if(name) {
        nextFlow();
        createRide();
      };
    });

    $('#ride-name').keypress(function(e) {
      if(e.which == 13) {
        name = $('#ride-name').val();
        console.log(name);
        if(name) {
          nextFlow();
          createRide();
        };
      // enter pressed
      };
    });
  //End ride name functions

  

    //Process seat booking functions
    var user_id;
     <% if current_user != nil %>
       user_id = <%= current_user.id %>
     <%end%>
     console.log(user_id);


    var createRide = function() {
      
      var url = '<%= create_ride_path %>';
  
      post_params = {
        "ride": {
          "origin": origin,
          "event_id": '<%= @event.id %>',
          "max_seats": max_seats,
          "price_per_seat": price_per_seat,
          "departure_time_local": departure_time_local,
          "title": name,
          "user_id": user_id,
          "image": "http://www.blogcdn.com/www.gadling.com/media/2012/03/road-trips-581.jpg",
          // num seats,
          // price etc,
        }
      }

      console.log(post_params);

      $.ajax({ url: url,
        type: 'POST',
        data: post_params,
        beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
        success: function(response) {
          // $('#someDiv').html(response);
          // alert('yes');
          console.log('Woohoo! ', response.message);
          window.location.reload();
        },
        error: function(response) {
          // alert('fail');
          console.log('Oh no! ', response.responseJSON.message);
          // console.log(response);
        }
      });
    };
 
  });

</script>
